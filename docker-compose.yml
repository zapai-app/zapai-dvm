services:
  zapai-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zapai-dvm
    restart: unless-stopped
    user: "1000:1000"

    # Load runtime env vars from local .env (must be next to docker-compose.yml).
    # Note: Docker Compose variable substitution (${VAR}) also relies on a local .env
    # file (or exported shell env vars). If you're seeing "variable is not set",
    # ensure you're running `docker compose` from this directory and `.env` exists.
    env_file:
      - .env
    
    # Environment variables
    environment:
      # Required
      BOT_PRIVATE_KEY: ${BOT_PRIVATE_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      # Optional alias used by some Google AI SDK setups
      GOOGLE_GENERATIVE_AI_API_KEY: ${GOOGLE_GENERATIVE_AI_API_KEY:-}

      BOT_NAME: ${BOT_NAME:-ZapAI}
      NOSTR_RELAYS: ${NOSTR_RELAYS}
      # Default 0 for fastest responses; override in .env if desired
      BOT_RESPONSE_DELAY: ${BOT_RESPONSE_DELAY:-0}
      WEB_PORT: ${WEB_PORT:-3000}

      # Scalability
      MAX_CONCURRENT: ${MAX_CONCURRENT:-10}
      MAX_QUEUE_SIZE: ${MAX_QUEUE_SIZE:-10000}
      RATE_LIMIT_MAX_TOKENS: ${RATE_LIMIT_MAX_TOKENS:-50}
      RATE_LIMIT_REFILL_RATE: ${RATE_LIMIT_REFILL_RATE:-5}
      QUEUE_TIMEOUT: ${QUEUE_TIMEOUT:-60000}

      # Optional auth
      DASHBOARD_PASSWORD: ${DASHBOARD_PASSWORD}
    
    # Port mapping
    ports:
      - "${WEB_PORT:-3000}:${WEB_PORT:-3000}"
    
    # Volume for persistent data
    volumes:
      - ./data:/app/data
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  default:
    name: zapai-network
